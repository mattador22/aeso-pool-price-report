<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>AESO Pool Price</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:sans-serif;max-width:1000px;margin:40px auto}
    #controls{margin-bottom:12px}
    #toggles label{margin-right:12px;font-size:.9rem}
    canvas{max-width:100%}
  </style>
</head>
<body>
  <h1>AESO Pool Price</h1>

  <div id="controls">
    From <input id="start" type="date" value="2000-01-01">
    To   <input id="end"   type="date" value="2025-05-31">
    <button id="btn">Fetch</button>
  </div>

  <!-- toggle menu -->
  <div id="toggles">
    <label><input type="checkbox" data-dsx="0" checked> Pool Price</label>
    <label><input type="checkbox" data-dsx="1" checked> Forecast</label>
    <label><input type="checkbox" data-dsx="2" checked> 30-Day Avg</label>
  </div>

  <h2>AESO Pool Price</h2>
  <canvas id="chart"  height="120"></canvas>

  <h2>Average Pool Price by Hour</h2>
  <canvas id="chart2" height="120"></canvas>

<script>
/* ---------- configuration -------------------------------------------- */
const proxy = 'https://aesoprice-proxy.matt-e74.workers.dev/';   // Worker URL

/* ---------- helpers --------------------------------------------------- */
function sliceDates(startISO, endISO, maxDays){
  const out = [];
  let s = new Date(startISO);
  const end = new Date(endISO);
  while (s <= end) {
    const e = new Date(s); e.setDate(e.getDate() + maxDays - 1);
    if (e > end) e.setTime(end.getTime());
    out.push({start:s.toISOString().slice(0,10), end:e.toISOString().slice(0,10)});
    s.setDate(s.getDate() + maxDays);
  }
  return out;
}

/* ---------- charts ---------------------------------------------------- */
const ctx1 = document.getElementById('chart');
const ctx2 = document.getElementById('chart2');

/* main line-chart */
const lineChart = new Chart(ctx1, {
  type:'line',
  data:{labels:[],datasets:[
    {label:'Pool Price',  data:[], borderColor:'#1976d2', borderWidth:1, pointRadius:2, fill:false},
    {label:'Forecast',    data:[], borderColor:'#ff9800', borderWidth:1, pointRadius:0, fill:false},
    {label:'30-Day Avg',  data:[], borderColor:'#d32f2f', borderWidth:1, pointRadius:0, fill:false}
  ]},
  options:{
    plugins:{legend:{display:false}},
    scales:{
      y:{
        beginAtZero:true,
        title:{display:true,text:'AESO Pool Price ($CAD/MWh)'}
      }
    }
  }
});

/* hourly bar-chart */
const hrs = [...Array(24).keys()].map(h=>h.toString().padStart(2,'0')+':00');

const barChart = new Chart(ctx2, {
  type:'bar',
  data:{labels:hrs,datasets:[
    {label:'Avg $/MWh', data:[], backgroundColor:'#1976d2'}
  ]},
  options:{
    scales:{
      x:{ title:{display:true,text:'Hour'} },
      y:{ beginAtZero:true,
          title:{display:true,text:'AESO Pool Price ($CAD/MWh)'} }
    }
  }
});

/* ---------- fetch + update ------------------------------------------- */
async function load() {
  const s = document.getElementById('start').value;
  const e = document.getElementById('end').value;

  /* API allows â‰¤365-day windows; slice if necessary */
  const slices = sliceDates(s, e, 365);
  const rows = [];

  try{
    for (const rng of slices) {
      const url = `${proxy}?startDate=${rng.start}&endDate=${rng.end}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error(`API ${res.status}`);
      const js  = await res.json();
      const arr = js.return?.['Pool Price Report'] ?? js['Pool Price Report'] ?? [];
      rows.push(...arr);
    }
  }catch(err){
    alert('Data fetch failed: '+err);
    console.error(err);
    return;
  }

  /* update line-chart */
  lineChart.data.labels            = rows.map(r=>r.begin_datetime_utc);
  lineChart.data.datasets[0].data  = rows.map(r=>+r.pool_price);
  lineChart.data.datasets[1].data  = rows.map(r=>+r.forecast_pool_price);
  lineChart.data.datasets[2].data  = rows.map(r=>+r.rolling_30day_avg);
  lineChart.update();

  /* hourly averages */
  const bucket = Array.from({length:24},()=>({sum:0,cnt:0}));
  rows.forEach(r=>{
    const h = new Date(r.begin_datetime_utc.replace(' ','T')+'Z').getUTCHours();
    bucket[h].sum += +r.pool_price; bucket[h].cnt++;
  });
  barChart.data.datasets[0].data = bucket.map(b=>b.cnt?+(b.sum/b.cnt).toFixed(2):null);
  barChart.update();
}

/* ---------- toggles for datasets ------------------------------------- */
document.querySelectorAll('#toggles input').forEach(cb=>{
  cb.addEventListener('change', e=>{
    const i = +e.target.dataset.dsx;
    lineChart.data.datasets[i].hidden = !e.target.checked;
    lineChart.update();
  });
});

/* ---------- init ------------------------------------------------------ */
document.getElementById('btn').onclick = load;
load();
</script>
</body>
</html>
